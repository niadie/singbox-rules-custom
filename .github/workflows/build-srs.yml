name: Build Sing-box Ruleset

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install sing-box
        run: |
          go install -v -tags with_quic,with_dhcp,with_wireguard,with_ech,with_utls,with_reality_server,with_clash_api,with_gvisor github.com/sagernet/sing-box/cmd/sing-box@latest

      - name: Compile Rulesets
        run: |
          # 进入 rules 文件夹
          cd rules
          
          # 这是一个循环命令：找到所有 .json 文件，自动编译
          for file in *.json; do
            echo "正在编译: $file ..."
            # ${file%.json}.srs 的意思是：把文件名里的 .json 去掉，换成 .srs
            sing-box ruleset compile "$file" -o "${file%.json}.srs"
          done
          
          # 列出一下生成的文件，方便在日志里检查
          ls -lh *.srs

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release'
        with:
          # 这里告诉它：去 rules 文件夹里把所有 srs 文件抓取出来上传
          files: rules/*.srs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
